---
import Main from '../../layouts/Main.astro'
import ProductBreadcrumb from '../../components/product/ProductBreadcrumb.astro'
import ProductGallery from '../../components/product/ProductGallery.astro'
import ProductInfo from '../../components/product/ProductInfo.astro'
import ProductDetails from '../../components/product/ProductDetails.astro'
import ProductReviews from '../../components/product/ProductReviews.astro'
import RelatedProducts from '../../components/product/RelatedProducts.astro'
import { wordpressService } from '../../services/wordpress'
import sanitizeHtml from 'sanitize-html'

// Generar rutas estáticas para todos los productos
export async function getStaticPaths() {
	try {
		const products = await wordpressService.getProducts()

		return products.map((product: any) => ({
			params: { slug: product.slug },
			props: { product, allProducts: products },
		}))
	} catch (error) {
		console.error('Error loading products for static paths:', error)
		return []
	}
}

// Obtener producto y productos relacionados desde props
const { product, allProducts } = Astro.props

// Obtener reseñas del producto
let productReviews: any[] = []
try {
	productReviews = await wordpressService.getProductReviews(product.id)
} catch (error) {
	console.error('Error loading product reviews:', error)
}

// Obtener productos relacionados de la misma categoría
const relatedProducts = allProducts
	.filter((p: any) => p.category === product.category && p.id !== product.id)
	.slice(0, 4)

// Calcular precio con descuento si aplica
const hasDiscount = product.onSale && product.salePrice
const originalPrice = product.price
const salePrice = hasDiscount ? product.salePrice : null
const discountPercentage = hasDiscount
	? Math.round(((originalPrice - salePrice) / originalPrice) * 100)
	: null

// Sanitizar descripción del producto
const sanitizedDescription = sanitizeHtml(product.description, {
	allowedTags: sanitizeHtml.defaults.allowedTags.concat([
		'h2',
		'h3',
		'h4',
		'h5',
		'h6',
		'ol',
		'ul',
		'li',
		'p',
		'strong',
		'em',
		'code',
		'b',
		'span',
		'i',
	]),
	allowedAttributes: {
		'*': ['data-start', 'data-end'], // Permitir atributos personalizados
	},
})
---

<Main title={`${product.name} - Store for Devs`} description={product.description}>
  <div class="product-page">
    <ProductBreadcrumb category={product.category} productName={product.name} />

    <div class="product-main">
      <ProductGallery 
        images={product.image} 
        imageAlts={product.imageAlt} 
        productName={product.name}
        hasDiscount={hasDiscount}
        discountPercentage={discountPercentage || undefined}
      />
      
      <ProductInfo 
        name={product.name}
        price={originalPrice}
        salePrice={salePrice}
        hasDiscount={hasDiscount}
        attributes={product.attributes}
        tags={product.tags}
        category={product.category}
      />
    </div>

    <ProductDetails sanitizedDescription={sanitizedDescription} />

    <ProductReviews 
      reviews={productReviews} 
      productName={product.name}
      reviewsAllowed={product.reviewsAllowed}
    />

    <RelatedProducts products={relatedProducts} />
  </div>
</Main>

<style>
  .product-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: var(--bg-primary);
  }

  .product-main {
    display: grid;
    grid-template-columns: 1fr;
    gap: 40px;
    margin-bottom: 60px;
  }

  /* Tablet */
  @media (width >= 768px) {
    .product-page {
      padding: 40px;
    }

    .product-main {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Desktop */
  @media (width >= 1024px) {
    .product-page {
      padding: 60px;
    }
  }
</style>


